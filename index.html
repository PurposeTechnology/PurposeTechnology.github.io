#!/bin/bash
################################################################################
#                           reconfigurationScript                              #
#                                                                              #
# This script is suppose to be uploaded and used with internet connection.     #
# The remote user of this script is supposed to use terminal emulator.         #
# To access the script and run it.                                             #
#                                                                              #
#   I Recommend the GET command alias of lwp-request command                   #
#   and the most popular command-line interpreter Bash.                        #
#                                                                              #
#    GET https://example.org/reconfgurationScript.bash | bash                  #
#                                                                              #
#    However the same results can be achieved with                             #
#    other command-line tools like curl and wget                               #
#                                                                              #
#                                                                              #
#                                  NOTES                                       #
#                                                                              #
#                                                                              #
#                                                                              #
#                                                                              #
################################################################################

function installExtension(){
	declare extensionUUID=$1;
	declare server="https://extensions.gnome.org/download-extension";
	declare version="?shell_version=9.99.9";
	declare url="$server/$extensionUUID.shell-extension.zip$version";
	wget "$url";

	declare download_filename=$(basename "$url");
	gnome-extensions install "$download_filename";
	gnome-extensions enable "$download_filename";

	rm "$filename";
	
}


function main(){

# --- Gnome-Shell Version Check --------------------------------------------
	# This script requires gnome-extensions command line tool 
	# This command line tool is required to install Gnome Extensions 
	# The extensions won't be installed and schemes for these extensions - not found
	declare current_gnome_version=$(gnome-shell --version | cut -d ' ' -f3 | tr "." ",");
	declare gnome_extensions_introduced_in_version="3,34,1";
	if (( current_gnome_version < gnome_extensions_introduced_in-version )); then
	    echo Your Gnome Shell version is incompatible - too old.
	    echo gnome-extensions command line tool has not been introduced yet in your version of Gnome.
	    read -p "Press [Enter] key to exit...";
	    exit
	fi

# --- Undo Changes --------------------------------------------
	# If the reconfiguration has been done before undo the changes to the system
	if [ -f "$HOME/.config/reconfiguration/reconfigurationHasBeenDoneBefore" ]; then
		# Remove extensions
		gnome-extensions uninstall "dash-to-panel@jderose9.github.com";
		gnome-extensions uninstall "ding@rastersoft.com;
		gnome-extensions enable "ubuntu-dock@ubuntu.com";
		gnome-extensions enable "desktop-icons@csoriano";
		busctl --user call org.gnome.Shell /org/gnome/Shell org.gnome.Shell Eval s 'Meta.restart("Restarting…")'
		
		rm -rf "$HOME/.config/reconfiguration/"
		exit
	fi


# --- Extension Installation --------------------------------------------
	# Dash to Dock
	installExtension "dash-to-panel@jderose9.github.com";

	declare dash_to_panel_schemas="$HOME/.local/share/gnome-shell/extensions/dash-to-panel@jderose9.github.com/schemas"
	gsettings --schemadir "$dash_to_panel_schemas" set org.gnome.shell.extensions.dash-to-panel panel-size 46;
	gsettings --schemadir "$dash_to_panel_schemas" set org.gnome.shell.extensions.dash-to-panel appicon-padding 5;
	gsettings --schemadir "$dash_to_panel_schemas" set org.gnome.shell.extensions.dash-to-panel window-preview-size 150;

	# Desktop Icons NG
	installExtension "ding@rastersoft.com";

	declare desktop_icons_ng_schemas="$HOME/.local/share/gnome-shell/extensions/ding@rastersoft.com/schemas";
	gsettings --schemadir "$desktop_icons_ng_schemas" set org.gnome.shell.extensions.ding icon-size "small";
	
	busctl --user call org.gnome.Shell /org/gnome/Shell org.gnome.Shell Eval s 'Meta.restart("Restarting…")'
	
# --- Option processing -------------------------------------------------




	mkdir "$HOME/.config/reconfiguration";
	echo "" > "$HOME/.config/reconfiguration/reconfigurationHasBeenDoneBefore";
}
main;
